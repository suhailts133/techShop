<% layout("../layouts/boilerplate") %>
    <title>
        <%= title %>
    </title>
    <style>
        /* Related Products Card Styling */
.product-card {
  border: none;
  border-radius: 8px;
  transition: all 0.3s ease;
  box-shadow: 0 2px 8px rgba(0,0,0,0.04);
}

.product-card:hover {
  transform: translateY(-3px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.08);
}

.card-img-top.product-img {
  height: 200px;
  object-fit: cover;
  border-radius: 8px 8px 0 0;
}

.product-title {
  font-size: 0.95rem;
  font-weight: 500;
  margin-bottom: 8px;
  line-height: 1.3;
  height: 2.6em;
  overflow: hidden;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
}

.variant-info {
  font-size: 0.85rem;
  color: #6c757d;
  margin-bottom: 8px;
}

.price-new {
  font-size: 1.1rem;
  font-weight: 600;
  color: #2ecc71;
}

.price-old {
  font-size: 0.85rem;
  color: #e74c3c;
}

.wishlist-icon {
  transition: all 0.2s ease;
}

.wishlist-icon i {
  font-size: 1.2rem;
}

.wishlist-icon:hover {
  transform: scale(1.1);
}
    </style>
    <div class="container mt-4">
        <!-- Breadcrumb Navigation -->
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb bg-light p-3 rounded">
                <li class="breadcrumb-item"><a href="/">Home</a></li>
                <li class="breadcrumb-item"><a href="/shop">shop</a></li>
                <li class="breadcrumb-item active" aria-current="page">
                    <%= product.productName %>
                </li>
            </ol>
        </nav>

        <!-- Main Product Section -->
        <div class="row bg-white shadow-sm p-4 rounded">
            <!-- Product Images -->
             <div class="col-md-6">
        <div class="main-image-container mb-3">
            <img id="main-image" 
                 src="/uploads/products/<%= product.productImage[0] %>" 
                 class="drift-trigger img-fluid rounded"
                 alt="Main Product Image"
                 data-zoom="<%= product.productImage[0] %>">
                 <div id="wishlist-icon"
     style="position: absolute; top: 10px; right: 10px; cursor: pointer;"
     data-product-id="<%= product._id %>">
     <i class="bi bi-heart fs-3 text-dark"></i>
</div>

        </div>


        <div id="test"></div>
        <div class="thumbnail-gallery d-flex">
            <% product.productImage.forEach(image=> { %>
            <img src="/uploads/products/<%= image %>" 
                 alt="Thumbnail" 
                 class="img-thumbnail me-2 rounded"
                 style="width: 70px; height: 70px; cursor: pointer;"
                 onclick="updateMainImage('/uploads/products/<%= image %>')">
            <% }); %>
        </div>
    </div>
    

            <!-- Product Details -->
            <div class="col-md-6">
                <h2 class="fw-bold mb-3">
                    <%= product.productName %>
                </h2>
                <p class="text-muted">
                    <%= product.description %>
                </p>
                <p class="text-muted">Brand: <span class="fw-bold">
                        <%= product.brand %>
                    </span></p>
                <p class="text-muted">Category: <span class="fw-bold">
                        <%= product.category.name %>
                    </span></p>

                <!-- Price Section -->
                <div class="mb-4">
                    <p>
                        <span class="text-success fw-bold fs-4">₹<span id="price">
                                <%= product.variants[0].discountedPrice %>
                            </span></span>
                        <span class="text-decoration-line-through text-muted ms-2 fs-5">₹<span id="regular-price">
                                <%= product.variants[0].price.toFixed(2) %>
                            </span></span>
                        <% if (product.variants[0].applicableOffer> 0) { %>
                            <span class="badge bg-danger ms-2 fs-6">-<%= product.variants[0].applicableOffer %>%
                                    OFF</span>
                            <% } %>
                    </p>
                </div>

                <!-- Variant Selection -->
                <div class="mb-3">
                    <label for="variant" class="form-label fw-semibold">Select Variant:</label>
                    <select id="variant" class="form-select" data-product-id="<%= product._id %>"
                        onchange="updateVariantDetails()">
                        <% product.variants.forEach(variant=> { %>
                            <option value="<%= variant._id %>">
                                <%= variant.color %> - <%= variant.size %>
                            </option>
                            <% }) %>
                    </select>
                </div>

                <!-- Quantity Selector -->
                <div class="quantity-control d-flex align-items-center mb-4">
                    <button class="btn btn-outline-secondary me-2" onclick="changeQuantity(-1)"
                        <%=product.variants[0].quantity===0 ? 'disabled' : '' %>>-</button>
                    <span id="selected-quantity" class="fs-5 fw-semibold">
                        <%= product.variants[0].quantity===0 ? 0 : 1 %>
                    </span>
                    <button class="btn btn-outline-secondary ms-2" onclick="changeQuantity(1)"
                        <%=product.variants[0].quantity===0 ? 'disabled' : '' %>>+</button>
                    <div class="ms-3">
                        <p class="text-muted mb-0">
                            Available Quantity:
                            <span id="quantity"
                                class="<%= product.variants[0].quantity === 0 ? 'text-danger fw-bold' : '' %>">
                                <%= product.variants[0].quantity===0 ? 'Out of Stock' : product.variants[0].quantity %>
                            </span>
                        </p>
                        <p id="quantity-error" class="text-danger fw-bold small mt-1" style="display: none;">Exceeds
                            available quantity.</p>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div>
                    <button class="btn btn-primary btn-lg me-2" <%=product.variants[0].quantity===0 ? 'disabled' : '' %>
                        onclick="addToCart()">Add to Cart</button>
                    <div id="cart-message" class="mt-3"></div>
                   
                </div>
            </div>
        </div>

        <!-- Related Products Section -->
        <!-- Related Products Section -->
<div class="related-products mt-5">
    <h3 class="fw-bold mb-4">Related Products</h3>
    <div class="row row-cols-2 row-cols-md-3 row-cols-lg-4 g-3">
      <% relatedProducts.forEach(product=> {
        const variant = product.variants.find(v => v.quantity > 0); %>
        <% if (variant) { %>
          <div class="col">
            <div class="card product-card h-100">
              <a href="/productDetails?id=<%= product._id %>">
                <img src="/uploads/products/<%= product.productImage[0] %>" 
                     class="card-img-top product-img"
                     alt="<%= product.productName %>">
              </a>
              <div class="card-body d-flex flex-column">
                <h5 class="product-title"><%= product.productName %></h5>
                
                <div class="variant-info">
                  <%= variant.color %> - <%= variant.size %>
                </div>
  
                <div class="mt-auto">
                  <div class="d-flex justify-content-between align-items-center">
                    <div>
                      <span class="price-new">₹<%= variant.discountedPrice %></span>
                      <span class="price-old ms-2"><s>₹<%= variant.price.toFixed(2) %></s></span>
                    </div>
                    <div class="wishlist-icon" 
                         data-product-id="<%= product._id %>" 
                         data-variant-id="<%= variant._id %>">
                      <% const isInWishlist = wishlistItems.some(item => 
                        item.productId === product._id.toString() && 
                        item.variantId === variant._id.toString()
                      ); %>
                      <i class="bi <%= isInWishlist ? 'bi-heart-fill text-danger' : 'bi-heart' %>"></i>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        <% } %>
      <% }) %>
    </div>
  </div>
    </div>
  
    <% if (product.reviews && product.reviews.length > 0) { %>
        <div class="reviews-list">
            <% product.reviews.forEach(review => { %>
                <div class="card mb-3">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="card-title mb-0">
                                <%= review.user.name %>
                            </h6>
                            <div class="rating">
                                <% for (let i = 1; i <= 5; i++) { %>
                                    <span class="star <%= i <= review.rating ? 'text-warning' : 'text-muted' %>">★</span>
                                <% } %>
                            </div>
                        </div>
                        <p class="card-text text-muted">
                            <%= review.review %>
                        </p>
                        <small class="text-muted">
                            Reviewed on: <%= new Date(review.createdAt).toLocaleDateString() %>
                        </small>
                    </div>
                </div>
            <% }); %>
        </div>
    <% } else { %>
        <p class="text-muted">No reviews yet. Be the first to review this product!</p>
    <% } %>
</div>


<script src="https://cdn.jsdelivr.net/npm/drift-zoom@1.3.0/dist/Drift.min.js"></script>

    

    <script src="/js/productDetail.js"></script>
    <script src="/js/imageZoom.js"></script>
    <script src="/js/wishlist.js" ></script>
    <script src="/js/homeShopWishlist.js"></script>